<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Quét Mã Đơn Hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #scanned-list {
            max-height: 250px;
            overflow-y: auto;
        }
        .laser {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: red;
            box-shadow: 0 0 10px red;
            animation: scanning 1.5s infinite linear;
        }
        @keyframes scanning {
            0% { top: 0; }
            50% { top: 99%; }
            100% { top: 0; }
        }
        #qr-reader video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-6 text-center">
        <h1 class="text-3xl font-bold mb-2">Trình Quét Mã Đơn Hàng</h1>
        <p class="text-gray-400 mb-6">Đưa mã vạch hoặc QR code vào khung để tự động quét.</p>

        <div id="qr-reader" class="w-full h-64 md:h-80 bg-gray-700 rounded-lg overflow-hidden relative border-2 border-gray-600 transition-all duration-300">
            <div class="laser"></div>
        </div>
        
        <!-- Đã xóa ô hiển thị trạng thái -->

        <div class="mt-6 w-full">
            <h2 class="text-xl font-semibold mb-3">Lịch sử quét gần đây</h2>
            <ul id="scanned-list" class="bg-gray-700 rounded-lg p-3 text-left space-y-2">
                <li class="text-gray-500 italic">Chưa có mã nào được quét...</li>
            </ul>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxH3sE9lgskgyJsNQsPf3D_c7xNLuJsNF2pm6BSRObSCQ5ABzyhZWm0Zst3xWYAUZm_IA/exec';

            const qrReaderDiv = document.getElementById('qr-reader');
            const scannedList = document.getElementById('scanned-list');
            let lastScannedCode = null;
            let isProcessing = false;
            const beepSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"+Array(1e3).join("123"));
            
            function addToScannedList(code) {
                if(scannedList.querySelector('.italic')) {
                    scannedList.innerHTML = '';
                }
                const li = document.createElement('li');
                li.className = "bg-gray-800 p-2 rounded-md flex justify-between items-center animate-pulse once";
                li.innerHTML = `<span>${code}</span><span class="text-xs text-gray-400">${new Date().toLocaleTimeString()}</span>`;
                scannedList.prepend(li);
            }

            function onScanSuccess(decodedText, decodedResult) {
                if (isProcessing || decodedText === lastScannedCode) {
                    return;
                }
                
                isProcessing = true;
                lastScannedCode = decodedText;
                beepSound.play();
                // Không cập nhật UI trạng thái nữa

                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ code: decodedText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        addToScannedList(decodedText);
                    } else {
                        throw new Error(data.message || 'Lỗi không xác định.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Hiển thị lỗi bằng cách nhấp nháy viền đỏ
                    qrReaderDiv.classList.remove('border-gray-600');
                    qrReaderDiv.classList.add('border-red-500');
                    setTimeout(() => {
                        qrReaderDiv.classList.remove('border-red-500');
                        qrReaderDiv.classList.add('border-gray-600');
                    }, 1000);
                })
                .finally(() => {
                    setTimeout(() => {
                        isProcessing = false;
                        lastScannedCode = null; 
                    }, 500);
                });
            }
            
            function onScanFailure(error) {
                // Không cần làm gì
            }

            const html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error(`Không thể khởi động trình quét: ${err}`);
                qrReaderDiv.innerHTML = `<p class="p-4 text-red-400">Lỗi: Không thể bật camera sau.</p>`;
            });
        });
    </script>
</body>
</html>

