<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Quét Mã Đơn Hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #qr-reader-results, #scanned-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .laser {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: red;
            box-shadow: 0 0 10px red;
            animation: scanning 1.5s infinite linear;
        }
        @keyframes scanning {
            0% { top: 0; }
            50% { top: 99%; }
            100% { top: 0; }
        }
        /* Style cho video camera để lấp đầy khung chứa */
        #qr-reader video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-6 text-center">
        <h1 class="text-3xl font-bold mb-2">Trình Quét Mã Đơn Hàng</h1>
        <p class="text-gray-400 mb-6">Đưa mã vạch hoặc QR code vào khung để tự động quét.</p>

        <div id="qr-reader" class="w-full h-64 md:h-80 bg-gray-700 rounded-lg overflow-hidden relative border-2 border-gray-600">
            <div class="laser"></div>
        </div>
        
        <div id="result" class="mt-4 p-3 rounded-lg text-sm font-medium h-12 flex items-center justify-center transition-all duration-300"></div>

        <div class="mt-6 w-full">
            <h2 class="text-xl font-semibold mb-3">Lịch sử quét gần đây</h2>
            <ul id="scanned-list" class="bg-gray-700 rounded-lg p-3 text-left space-y-2">
                <li class="text-gray-500 italic">Chưa có mã nào được quét...</li>
            </ul>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxH3sE9lgskgyJsNQsPf3D_c7xNLuJsNF2pm6BSRObSCQ5ABzyhZWm0Zst3xWYAUZm_IA/exec';

            const resultDiv = document.getElementById('result');
            const scannedList = document.getElementById('scanned-list');
            let lastScannedCode = null;
            let isProcessing = false;
            const beepSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"+Array(1e3).join("123"));

            function updateResult(message, isError = false) {
                resultDiv.textContent = message;
                resultDiv.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'text-green-100', 'text-red-100', 'text-yellow-100');
                if (isError) {
                    resultDiv.classList.add('bg-red-500', 'text-red-100');
                } else if (message.includes('thành công')) {
                     resultDiv.classList.add('bg-green-500', 'text-green-100');
                } else if (message) {
                    resultDiv.classList.add('bg-yellow-500', 'text-yellow-100');
                }
            }
            
            function addToScannedList(code) {
                if(scannedList.querySelector('.italic')) {
                    scannedList.innerHTML = '';
                }
                const li = document.createElement('li');
                li.className = "bg-gray-800 p-2 rounded-md flex justify-between items-center";
                li.innerHTML = `<span>${code}</span><span class="text-xs text-gray-400">${new Date().toLocaleTimeString()}</span>`;
                scannedList.prepend(li);
            }

            function onScanSuccess(decodedText, decodedResult) {
                if (isProcessing || decodedText === lastScannedCode) {
                    return;
                }
                
                isProcessing = true;
                lastScannedCode = decodedText;
                beepSound.play();
                updateResult(`Đang xử lý mã: ${decodedText}`);

                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({ code: decodedText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateResult(`Quét thành công: ${decodedText}`);
                        addToScannedList(decodedText);
                    } else {
                        throw new Error(data.message || 'Lỗi không xác định từ server.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    updateResult(`Lỗi: ${error.message}`, true);
                })
                .finally(() => {
                    setTimeout(() => {
                        isProcessing = false;
                        lastScannedCode = null; 
                    }, 500);
                });
            }
            
            function onScanFailure(error) {
                // Không cần làm gì ở đây vì camera quét liên tục
            }

            // *** THAY ĐỔI: Sử dụng cách mới để khởi động camera trực tiếp ***
            const html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            // Bắt đầu quét bằng camera sau. 
            // Thư viện sẽ tự động xử lý yêu cầu quyền truy cập của trình duyệt.
            html5QrCode.start(
                { facingMode: "environment" }, // Yêu cầu camera sau
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error(`Không thể khởi động trình quét: ${err}`);
                updateResult("Lỗi: Không thể bật camera sau.", true);
            });
        });
    </script>
</body>
</html>

