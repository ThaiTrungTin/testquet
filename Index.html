<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quét Mã Đơn Hàng</title>
    <!-- Sử dụng Tailwind CSS để có giao diện đẹp và đáp ứng nhanh chóng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tùy chỉnh nhỏ cho giao diện */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation; /* Tối ưu hóa cho cảm ứng */
        }

        #reader {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        /* Tạo hiệu ứng tia laser quét */
        #reader__scan_region:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #ef4444; /* Màu đỏ nổi bật */
            box-shadow: 0 0 10px #ef4444, 0 0 20px #ef4444;
            animation: scanning 2s infinite linear;
        }

        @keyframes scanning {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(calc(100% - 2px));
            }
        }
        
        /* Hiệu ứng mờ dần cho thông báo */
        .fade-out {
            animation: fadeOut 3s forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 font-sans">

    <div class="w-full max-w-md mx-auto text-center">
        <h1 class="text-3xl font-bold mb-2">Trình Quét Mã Đơn Hàng</h1>
        <p class="text-gray-400 mb-4">Đưa mã vạch hoặc QR code vào khung để tự động quét.</p>
        
        <!-- Phần hiển thị camera -->
        <div id="reader" class="w-full aspect-square bg-gray-800 rounded-lg shadow-lg"></div>

        <!-- Khu vực hiển thị kết quả và trạng thái -->
        <div id="status-container" class="mt-4 w-full h-16">
            <div id="result" class="bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-300">
                Đang khởi tạo camera...
            </div>
        </div>

        <!-- Lịch sử các mã đã quét -->
        <div class="mt-4 w-full">
            <h2 class="text-xl font-semibold mb-2">Lịch sử quét gần đây</h2>
            <ul id="scanned-list" class="bg-gray-800 rounded-lg p-3 h-40 overflow-y-auto flex flex-col-reverse">
                <li class="text-gray-500 text-center">Chưa có mã nào được quét.</li>
            </ul>
        </div>
    </div>

    <!-- Thư viện quét mã vạch -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // !!! QUAN TRỌNG: Dán URL ứng dụng web Apps Script của bạn vào đây
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxH3sE9lgskgyJsNQsPf3D_c7xNLuJsNF2pm6BSRObSCQ5ABzyhZWm0Zst3xWYAUZm_IA/exec';

            const resultDiv = document.getElementById('result');
            const scannedList = document.getElementById('scanned-list');
            let lastScannedCode = null;
            let isProcessing = false;

            // Hàm tạo âm thanh 'bíp' khi quét thành công
            function playBeep() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    gainNode.gain.value = 0.1;
                    oscillator.frequency.value = 880;
                    oscillator.type = 'sine';
                    oscillator.start();
                    setTimeout(() => oscillator.stop(), 100);
                } catch (e) {
                    console.error("Không thể phát âm thanh:", e);
                }
            }
            
            // Hàm hiển thị trạng thái
            function showStatus(message, type = 'info') {
                const colors = {
                    info: 'bg-blue-500',
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    processing: 'bg-yellow-500'
                };
                resultDiv.textContent = message;
                resultDiv.className = `text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-300 ${colors[type] || colors['info']}`;
            }

            // Hàm được gọi khi quét mã thành công
            async function onScanSuccess(decodedText, decodedResult) {
                if (isProcessing || decodedText === lastScannedCode) {
                    return;
                }
                
                if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') {
                    showStatus('Lỗi: Chưa cấu hình URL của Apps Script!', 'error');
                    return;
                }

                isProcessing = true;
                lastScannedCode = decodedText;
                
                playBeep();
                showStatus(`Đang gửi mã: ${decodedText}`, 'processing');

                // **THAY ĐỔI: Sử dụng fetch để gửi dữ liệu đến Apps Script Web App**
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors', // Cần thiết cho các yêu cầu từ tên miền khác
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ code: decodedText }),
                    });

                    if (!response.ok) {
                        throw new Error(`Lỗi HTTP: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        onServerSuccess(result.message);
                    } else {
                        onServerFailure({ message: result.message });
                    }

                } catch (error) {
                    onServerFailure(error);
                }
            }
            
            function onServerSuccess(responseMessage) {
                showStatus(responseMessage, 'success');
                addToList(lastScannedCode);
                resetScannerState();
            }

            function onServerFailure(error) {
                showStatus(`Lỗi: ${error.message}`, 'error');
                resetScannerState();
            }

            function resetScannerState() {
                setTimeout(() => {
                    lastScannedCode = null; 
                    isProcessing = false;
                    setTimeout(() => {
                        if (!isProcessing) {
                           showStatus('Sẵn sàng quét...', 'info');
                        }
                    }, 1500);
                }, 2000);
            }

            function addToList(code) {
                const placeholder = scannedList.querySelector('.text-gray-500');
                if (placeholder) placeholder.remove();

                const li = document.createElement('li');
                li.className = 'text-green-400 p-2 border-b border-gray-700';
                
                const codeText = document.createElement('span');
                codeText.className = 'font-mono';
                codeText.textContent = code;

                const timeText = document.createElement('span');
                timeText.className = 'text-xs text-gray-400 float-right pt-1';
                timeText.textContent = new Date().toLocaleTimeString();

                li.appendChild(codeText);
                li.appendChild(timeText);
                scannedList.prepend(li);
            }
            
            const html5Qrcode = new Html5Qrcode("reader");
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                facingMode: "environment" 
            };

            html5Qrcode.start({ facingMode: "environment" }, config, onScanSuccess)
                .then(() => {
                     showStatus('Sẵn sàng quét...', 'info');
                })
                .catch(err => {
                    console.error("Không thể khởi động camera:", err);
                    showStatus(`Lỗi Camera: ${err}`, 'error');
                });
        });
    </script>
</body>
</html>


